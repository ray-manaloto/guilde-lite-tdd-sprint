{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SDLC Orchestration Enhanced Hooks",
  "description": "Complete hook configuration with Stop, SubagentStop, checkpoints, and quality gates",
  "version": "2.0.0",

  "SessionStart": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "prompt",
          "prompt": "SDLC Orchestration plugin active (v2.0). Available workflows:\n- /sdlc-orchestration:full-feature - Complete SDLC with parallel agents\n- /sdlc-orchestration:phase <phase> - Run specific phase\n- /sdlc-orchestration:research - Parallel research with 3 agents (includes skill search)\n- /sdlc-orchestration:role <role> - Single role agent\n- /sdlc-orchestration:resume - Resume from last checkpoint\n\nPhases: requirements, design, implement, quality, release\nRoles: ceo, pm, architect, ba, research, staff, senior, junior, qa, reviewer, devops, network, cicd, canary, docs, perf, data\n\nENFORCEMENT ACTIVE:\n- Research tasks REQUIRE /sdlc-orchestration:research (WebSearch blocked otherwise)\n- Feature implementation REQUIRES /sdlc-orchestration:full-feature\n- User confirmation required before bypassing workflows\n- Crash recovery: session checkpoints auto-created"
        },
        {
          "type": "command",
          "command": "bash -c 'HEALTH_SCRIPT=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/scripts/health-check.sh\"; if [ -x \"$HEALTH_SCRIPT\" ]; then $HEALTH_SCRIPT 2>&1 || echo \"{\\\"addToPrompt\\\": \\\"[CLAUDE CODE CLI HEALTH CHECK FAILED]\\n\\nRun self-healing: ${CLAUDE_PROJECT_ROOT:-.}/.claude/scripts/self-heal-cli.sh\\\"}\"; fi; exit 0'",
          "timeout": 10
        },
        {
          "type": "command",
          "command": "bash -c 'CHECKPOINT_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-checkpoint.json\"; if [ -f \"$CHECKPOINT_FILE\" ]; then RECOVERED=$(jq -r \".recovery_pending // false\" \"$CHECKPOINT_FILE\" 2>/dev/null); if [ \"$RECOVERED\" = \"true\" ]; then PHASE=$(jq -r \".phase\" \"$CHECKPOINT_FILE\" 2>/dev/null); TRACK=$(jq -r \".track_id\" \"$CHECKPOINT_FILE\" 2>/dev/null); echo \"{\\\"addToPrompt\\\": \\\"[SDLC RECOVERY AVAILABLE]\\n\\nPrevious session checkpoint detected:\\n- Track: $TRACK\\n- Phase: $PHASE\\n- Status: Incomplete\\n\\nUse /sdlc-orchestration:resume to continue from checkpoint, or start fresh.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "SessionStop": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; CHECKPOINT_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-checkpoint.json\"; if [ -f \"$STATE_FILE\" ]; then PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); STATUS=$(jq -r \".phases.$PHASE.status // empty\" \"$STATE_FILE\" 2>/dev/null); if [ \"$STATUS\" = \"in_progress\" ]; then mkdir -p \"$(dirname \"$CHECKPOINT_FILE\")\"; jq \". + {\\\"recovery_pending\\\": true, \\\"checkpoint_at\\\": \\\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\\", \\\"session_id\\\": \\\"$(echo $RANDOM | md5sum | head -c 8 2>/dev/null || echo $RANDOM)\\\"} | .phase = \\\"$PHASE\\\"\" \"$STATE_FILE\" > \"$CHECKPOINT_FILE\" 2>/dev/null; echo \"[SDLC] Session checkpoint created for phase: $PHASE\" >> \"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-activity.log\"; fi; fi; exit 0'",
          "timeout": 10
        },
        {
          "type": "command",
          "command": "bash -c 'SYNC_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-doc-sync.json\"; if [ -f \"$SYNC_FILE\" ]; then CODE_COUNT=$(jq \".code_changes | length\" \"$SYNC_FILE\" 2>/dev/null || echo 0); if [ \"$CODE_COUNT\" -ge 3 ]; then echo \"{\\\"addToPrompt\\\": \\\"[CLAUDE.MD REVIEW SUGGESTED]\\n\\n$CODE_COUNT code files modified this session. Consider running /revise-claude-md to capture learnings.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "Stop": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; STOP_VALIDATION_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ); mkdir -p \"${CLAUDE_PROJECT_ROOT:-.}/.claude\"; VALIDATION=\"{\\\"timestamp\\\": \\\"$TIMESTAMP\\\", \\\"checks\\\": {}}\"; if [ -f \"$STATE_FILE\" ]; then PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); if [ -n \"$PHASE\" ]; then VALIDATION=$(echo \"$VALIDATION\" | jq \".phase = \\\"$PHASE\\\"\"); fi; fi; echo \"$VALIDATION\" > \"$STOP_VALIDATION_FILE\"; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'STOP_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; cd \"${CLAUDE_PROJECT_ROOT:-.}/backend\" 2>/dev/null && if command -v uv >/dev/null 2>&1; then RESULT=$(uv run pytest -x -q --tb=no 2>&1 | tail -5); if echo \"$RESULT\" | grep -qE \"(passed|PASSED)\"; then jq \".checks.tests_pass = true | .checks.test_output = \\\"$RESULT\\\"\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; else jq \".checks.tests_pass = false | .checks.test_output = \\\"$RESULT\\\"\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; fi; fi; exit 0'",
          "timeout": 120
        },
        {
          "type": "command",
          "command": "bash -c 'STOP_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; cd \"${CLAUDE_PROJECT_ROOT:-.}/backend\" 2>/dev/null && if command -v uv >/dev/null 2>&1 && command -v ruff >/dev/null 2>&1; then RESULT=$(uv run ruff check . --quiet 2>&1 | head -10); if [ -z \"$RESULT\" ]; then jq \".checks.lint_clean = true\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; else jq \".checks.lint_clean = false | .checks.lint_issues = \\\"$RESULT\\\"\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; fi; fi; exit 0'",
          "timeout": 30
        },
        {
          "type": "command",
          "command": "bash -c 'STOP_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; SYNC_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-doc-sync.json\"; if [ -f \"$SYNC_FILE\" ]; then PENDING=$(jq -r \".pending_sync // false\" \"$SYNC_FILE\" 2>/dev/null); jq \".checks.docs_synced = $([ \"$PENDING\" = \"false\" ] && echo \"true\" || echo \"false\")\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; else jq \".checks.docs_synced = true\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'STOP_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; if [ -f \"$STOP_FILE\" ]; then TESTS=$(jq -r \".checks.tests_pass // true\" \"$STOP_FILE\" 2>/dev/null); LINT=$(jq -r \".checks.lint_clean // true\" \"$STOP_FILE\" 2>/dev/null); DOCS=$(jq -r \".checks.docs_synced // true\" \"$STOP_FILE\" 2>/dev/null); WARNINGS=\"\"; if [ \"$TESTS\" = \"false\" ]; then WARNINGS=\"${WARNINGS}\\n- Tests are failing\"; fi; if [ \"$LINT\" = \"false\" ]; then WARNINGS=\"${WARNINGS}\\n- Lint issues detected\"; fi; if [ \"$DOCS\" = \"false\" ]; then WARNINGS=\"${WARNINGS}\\n- Documentation out of sync\"; fi; if [ -n \"$WARNINGS\" ]; then jq \".task_complete = false | .warnings = \\\"$WARNINGS\\\"\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC STOP VALIDATION]\\n\\nTask completion checks:$WARNINGS\\n\\nRecommendation: Address these issues before marking task complete.\\\"}\"; else jq \".task_complete = true\" \"$STOP_FILE\" > \"${STOP_FILE}.tmp\" && mv \"${STOP_FILE}.tmp\" \"$STOP_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC STOP VALIDATION] All checks passed. Task verified complete.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$STATE_FILE\" ]; then PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); if [ \"$PHASE\" = \"release\" ]; then echo \"{\\\"addToPrompt\\\": \\\"[PROJECT MEMORY CHECK]\\n\\nRelease phase complete. Before marking done:\\n1. Run /revise-claude-md to capture session learnings\\n2. Or use claude-md-improver skill for full audit\\n3. Or acknowledge: skip claude-md update\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "SubagentStop": [
    {
      "matcher": "sdlc-orchestration:.*",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); AGENT=$(echo \"$INPUT\" | jq -r \".subagent_type // empty\" 2>/dev/null); OUTPUT=$(echo \"$INPUT\" | jq -r \".result // empty\" 2>/dev/null); AGGREGATION_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-agent-outputs.json\"; STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ); mkdir -p \"${CLAUDE_PROJECT_ROOT:-.}/.claude\"; if [ ! -f \"$AGGREGATION_FILE\" ]; then echo \"{\\\"agents\\\": [], \\\"research_results\\\": [], \\\"phase_summaries\\\": {}}\" > \"$AGGREGATION_FILE\"; fi; ROLE=$(echo \"$AGENT\" | sed \"s/sdlc-orchestration://\"); if [ -n \"$ROLE\" ]; then ENTRY=\"{\\\"agent\\\": \\\"$ROLE\\\", \\\"completed_at\\\": \\\"$TIMESTAMP\\\", \\\"output_length\\\": $(echo \"$OUTPUT\" | wc -c)}\"; jq \".agents += [$ENTRY]\" \"$AGGREGATION_FILE\" > \"${AGGREGATION_FILE}.tmp\" && mv \"${AGGREGATION_FILE}.tmp\" \"$AGGREGATION_FILE\"; echo \"$(date) [SDLC] SubagentStop: $ROLE completed\" >> \"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-activity.log\"; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); AGENT=$(echo \"$INPUT\" | jq -r \".subagent_type // empty\" 2>/dev/null); if echo \"$AGENT\" | grep -qE \"(research-scientist|business-analyst|software-architect)\"; then AGGREGATION_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-agent-outputs.json\"; RESEARCH_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-research-results.json\"; TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ); ROLE=$(echo \"$AGENT\" | sed \"s/sdlc-orchestration://\"); mkdir -p \"${CLAUDE_PROJECT_ROOT:-.}/.claude\"; if [ ! -f \"$RESEARCH_FILE\" ]; then echo \"{\\\"started_at\\\": \\\"$TIMESTAMP\\\", \\\"agents_completed\\\": [], \\\"findings\\\": {}}\" > \"$RESEARCH_FILE\"; fi; COMPLETED=$(jq -r \".agents_completed | length\" \"$RESEARCH_FILE\" 2>/dev/null); jq \".agents_completed += [\\\"$ROLE\\\"] | .findings.$ROLE = {\\\"completed_at\\\": \\\"$TIMESTAMP\\\"}\" \"$RESEARCH_FILE\" > \"${RESEARCH_FILE}.tmp\" && mv \"${RESEARCH_FILE}.tmp\" \"$RESEARCH_FILE\"; NEW_COUNT=$((COMPLETED + 1)); if [ \"$NEW_COUNT\" -ge 3 ]; then jq \".all_complete = true | .completed_at = \\\"$TIMESTAMP\\\"\" \"$RESEARCH_FILE\" > \"${RESEARCH_FILE}.tmp\" && mv \"${RESEARCH_FILE}.tmp\" \"$RESEARCH_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC RESEARCH COMPLETE]\\n\\nAll 3 research agents have completed. Ready to aggregate findings:\\n- Research Scientist\\n- Business Analyst\\n- Software Architect\\n\\nCreate a consolidated research summary combining all agent outputs.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); AGENT=$(echo \"$INPUT\" | jq -r \".subagent_type // empty\" 2>/dev/null); STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$STATE_FILE\" ]; then ROLE=$(echo \"$AGENT\" | sed \"s/sdlc-orchestration://\"); PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); if [ -n \"$ROLE\" ] && [ -n \"$PHASE\" ]; then EXPECTED=$(jq -r \".agents_by_phase.$PHASE // []\" \"${CLAUDE_PROJECT_ROOT:-.}/.claude/plugins/sdlc-orchestration/skills/sdlc-orchestrator/templates/phase-state.json\" 2>/dev/null | jq -r \". | length\"); COMPLETED=$(jq -r \".phases.$PHASE.agents_completed // [] | length\" \"$STATE_FILE\" 2>/dev/null); COMPLETED=$((COMPLETED + 1)); if [ \"$COMPLETED\" -ge \"$EXPECTED\" ] 2>/dev/null; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC PHASE AGENTS COMPLETE]\\n\\nAll agents for phase $PHASE have completed ($COMPLETED/$EXPECTED).\\n\\nNext steps:\\n1. Aggregate agent outputs\\n2. Verify phase gate requirements\\n3. Update state to next phase\\\"}\"; fi; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "UserPromptSubmit": [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); PROMPT=$(echo \"$INPUT\" | jq -r \".prompt // empty\" 2>/dev/null); if [ -n \"$PROMPT\" ] && echo \"$PROMPT\" | grep -qiE \"(implement|build|create|develop|add).*(feature|module|system|service|functionality)\"; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC REQUIRED] Use /sdlc-orchestration:full-feature for structured development. Do NOT proceed without invoking the workflow.\\\"}\"; fi'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); PROMPT=$(echo \"$INPUT\" | jq -r \".prompt // empty\" 2>/dev/null); BYPASS_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-research-bypass.json\"; RESEARCH_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-research-active.json\"; if [ -n \"$PROMPT\" ] && echo \"$PROMPT\" | grep -qiE \"(research|investigate|evaluate|compare|analyze|review|audit|assess).*(technolog|librar|framework|tool|skill|approach|option|solution|pattern)\"; then if [ ! -f \"$RESEARCH_FILE\" ] && [ ! -f \"$BYPASS_FILE\" ]; then CONFIRM_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-pending-confirm.json\"; mkdir -p \"$(dirname \"$CONFIRM_FILE\")\"; echo \"{\\\"type\\\":\\\"research\\\",\\\"detected_at\\\":\\\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\\"}\" > \"$CONFIRM_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC CONFIRMATION REQUIRED]\\n\\nResearch task detected. You MUST ask the user:\\n\\n> This looks like a research task. I should use /sdlc-orchestration:research to spawn 3 parallel agents (Research Scientist, Business Analyst, Software Architect) for comprehensive investigation.\\n>\\n> Options:\\n> 1. Yes, use research workflow (recommended)\\n> 2. No, I want manual research (creates bypass)\\n>\\n> Which do you prefer?\\n\\nDo NOT proceed with any research tools until user responds.\\\"}\"; fi; fi'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); PROMPT=$(echo \"$INPUT\" | jq -r \".prompt // empty\" 2>/dev/null); if echo \"$PROMPT\" | grep -qiE \"sdlc-orchestration:(full-feature|phase)\"; then STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; CHECKPOINT_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-checkpoint.json\"; FEATURE=$(echo \"$PROMPT\" | sed -n \"s/.*[\\\"\\x27]\\([^\\\"\\x27]*\\)[\\\"\\x27].*/\\1/p\" | head -1); TRACK_ID=$(echo \"$FEATURE\" | tr \" \" \"-\" | tr \"[:upper:]\" \"[:lower:]\" | head -c 50); TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ); mkdir -p \"${CLAUDE_PROJECT_ROOT:-.}/.claude\"; cat > \"$STATE_FILE\" <<EOF\n{\"track_id\":\"$TRACK_ID\",\"current_phase\":\"requirements\",\"started_at\":\"$TIMESTAMP\",\"phases\":{\"requirements\":{\"status\":\"in_progress\",\"started_at\":\"$TIMESTAMP\",\"agents_completed\":[]},\"design\":{\"status\":\"pending\",\"agents_completed\":[]},\"implementation\":{\"status\":\"pending\",\"agents_completed\":[]},\"quality\":{\"status\":\"pending\",\"agents_completed\":[]},\"release\":{\"status\":\"pending\",\"agents_completed\":[]}},\"checkpoints\":[],\"handoffs\":[]}\nEOF\nrm -f \"$CHECKPOINT_FILE\" 2>/dev/null; echo \"{\\\"addToPrompt\\\": \\\"[SDLC] Created state file: $STATE_FILE. Phase tracking is now active.\\\"}\"; fi'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); PROMPT=$(echo \"$INPUT\" | jq -r \".prompt // empty\" 2>/dev/null); if echo \"$PROMPT\" | grep -qiE \"sdlc-orchestration:resume\"; then CHECKPOINT_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-checkpoint.json\"; STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$CHECKPOINT_FILE\" ]; then PHASE=$(jq -r \".phase // empty\" \"$CHECKPOINT_FILE\" 2>/dev/null); TRACK=$(jq -r \".track_id // empty\" \"$CHECKPOINT_FILE\" 2>/dev/null); cp \"$CHECKPOINT_FILE\" \"$STATE_FILE\"; jq \"del(.recovery_pending) | del(.checkpoint_at) | del(.session_id) | .phases.$PHASE.status = \\\"in_progress\\\"\" \"$STATE_FILE\" > \"${STATE_FILE}.tmp\" && mv \"${STATE_FILE}.tmp\" \"$STATE_FILE\"; rm -f \"$CHECKPOINT_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC RECOVERY] Resumed from checkpoint.\\n\\n- Track: $TRACK\\n- Phase: $PHASE\\n- Status: Continuing from last checkpoint\\n\\nReview the state file and continue with the current phase.\\\"}\"; else echo \"{\\\"addToPrompt\\\": \\\"[SDLC] No checkpoint found. Start fresh with /sdlc-orchestration:full-feature or /sdlc-orchestration:phase.\\\"}\"; fi; fi'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); PROMPT=$(echo \"$INPUT\" | jq -r \".prompt // empty\" 2>/dev/null); STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$STATE_FILE\" ]; then PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); if [ \"$PHASE\" = \"requirements\" ] && echo \"$PROMPT\" | grep -qiE \"(implement|code|build)\"; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC Gate] Design phase must complete before implementation. Current phase: requirements.\\\"}\"; elif [ \"$PHASE\" = \"design\" ] && echo \"$PROMPT\" | grep -qiE \"(deploy|release|production)\"; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC Gate] Implementation and quality phases must complete before release. Current phase: design.\\\"}\"; fi; fi'",
          "timeout": 5
        }
      ]
    }
  ],

  "PreToolUse": [
    {
      "matcher": "WebSearch",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'RESEARCH_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-research-active.json\"; BYPASS_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-research-bypass.json\"; CONFIRM_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-pending-confirm.json\"; if [ -f \"$CONFIRM_FILE\" ]; then echo \"{\\\"decision\\\": \\\"block\\\", \\\"reason\\\": \\\"[SDLC BLOCKED] Pending user confirmation for research workflow. Ask user to choose: (1) Yes, use /sdlc-orchestration:research or (2) No, manual research.\\\"}\"; elif [ ! -f \"$RESEARCH_FILE\" ] && [ ! -f \"$BYPASS_FILE\" ]; then echo \"{\\\"decision\\\": \\\"block\\\", \\\"reason\\\": \\\"[SDLC BLOCKED] WebSearch requires research workflow. Ask user: Should I use /sdlc-orchestration:research for parallel investigation?\\\"}\"; fi; exit 0'",
          "timeout": 5
        }
      ]
    },
    {
      "matcher": "Bash",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); CMD=$(echo \"$INPUT\" | jq -r \".tool_input.command // empty\" 2>/dev/null); if echo \"$CMD\" | grep -qE \"(git push|deploy|kubectl apply)\"; then STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$STATE_FILE\" ]; then PHASE=$(jq -r \".current_phase // empty\" \"$STATE_FILE\" 2>/dev/null); if [ \"$PHASE\" != \"release\" ]; then echo \"{\\\"decision\\\": \\\"block\\\", \\\"reason\\\": \\\"[SDLC BLOCKED] Deployment commands only allowed in release phase. Current: $PHASE\\\"}\"; fi; fi; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); CMD=$(echo \"$INPUT\" | jq -r \".tool_input.command // empty\" 2>/dev/null); if echo \"$CMD\" | grep -qE \"git commit\"; then STOP_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-stop-validation.json\"; if [ -f \"$STOP_FILE\" ]; then TESTS=$(jq -r \".checks.tests_pass // true\" \"$STOP_FILE\" 2>/dev/null); LINT=$(jq -r \".checks.lint_clean // true\" \"$STOP_FILE\" 2>/dev/null); if [ \"$TESTS\" = \"false\" ] || [ \"$LINT\" = \"false\" ]; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC PRE-COMMIT WARNING]\\n\\nQuality checks failed:\\n- Tests: $([ \\\"$TESTS\\\" = \\\"true\\\" ] && echo \\\"PASS\\\" || echo \\\"FAIL\\\")\\n- Lint: $([ \\\"$LINT\\\" = \\\"true\\\" ] && echo \\\"PASS\\\" || echo \\\"FAIL\\\")\\n\\nConsider fixing issues before committing.\\\"}\"; fi; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    },
    {
      "matcher": "Write",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); FILE=$(echo \"$INPUT\" | jq -r \".tool_input.file_path // empty\" 2>/dev/null); if echo \"$FILE\" | grep -qE \"\\.(py|ts|tsx|js|jsx)$\"; then echo \"[SDLC] Code write: $FILE\" >> \"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-activity.log\" 2>/dev/null; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "PostToolUse": [
    {
      "matcher": "Task",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); AGENT=$(echo \"$INPUT\" | jq -r \".tool_input.subagent_type // empty\" 2>/dev/null); if [ -n \"$AGENT\" ] && echo \"$AGENT\" | grep -q \"sdlc-orchestration:\"; then echo \"$(date +%Y-%m-%dT%H:%M:%S) [SDLC] Agent completed: $AGENT\" >> \"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-activity.log\" 2>/dev/null; STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; if [ -f \"$STATE_FILE\" ]; then ROLE=$(echo \"$AGENT\" | sed \"s/sdlc-orchestration://\"); PHASE=$(jq -r \".current_phase\" \"$STATE_FILE\" 2>/dev/null); COMPLETED=$(jq -r \".phases.$PHASE.agents_completed // []\" \"$STATE_FILE\" 2>/dev/null); if ! echo \"$COMPLETED\" | grep -q \"$ROLE\"; then jq \".phases.$PHASE.agents_completed += [\\\"$ROLE\\\"]\" \"$STATE_FILE\" > \"${STATE_FILE}.tmp\" && mv \"${STATE_FILE}.tmp\" \"$STATE_FILE\" 2>/dev/null; fi; fi; fi; exit 0'",
          "timeout": 5
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); AGENT=$(echo \"$INPUT\" | jq -r \".tool_input.subagent_type // empty\" 2>/dev/null); if [ -n \"$AGENT\" ] && echo \"$AGENT\" | grep -qE \"(sdlc-orchestration:docs|documentation-engineer|technical-writer)\"; then SYNC_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-doc-sync.json\"; if [ -f \"$SYNC_FILE\" ]; then jq \".last_doc_update = \\\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\\" | .pending_sync = false\" \"$SYNC_FILE\" > \"${SYNC_FILE}.tmp\" && mv \"${SYNC_FILE}.tmp\" \"$SYNC_FILE\" 2>/dev/null; echo \"{\\\"addToPrompt\\\": \\\"[SDLC DOC-SYNC] Documentation agent completed. Doc sync state cleared.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    },
    {
      "matcher": "Write",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); FILE=$(echo \"$INPUT\" | jq -r \".tool_input.file_path // empty\" 2>/dev/null); if echo \"$FILE\" | grep -qE \"\\.(py)$\"; then if command -v ruff >/dev/null 2>&1; then cd \"${CLAUDE_PROJECT_ROOT:-.}/backend\" 2>/dev/null && ruff check \"$FILE\" --quiet 2>/dev/null || echo \"{\\\"addToPrompt\\\": \\\"[SDLC Backpressure] Lint issues detected in $FILE. Run ruff check to see details.\\\"}\"; fi; fi; exit 0'",
          "timeout": 10
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); FILE=$(echo \"$INPUT\" | jq -r \".tool_input.file_path // empty\" 2>/dev/null); if echo \"$FILE\" | grep -qE \"\\.(ts|tsx)$\"; then if command -v tsc >/dev/null 2>&1; then cd \"${CLAUDE_PROJECT_ROOT:-.}/frontend\" 2>/dev/null && tsc --noEmit 2>/dev/null || echo \"{\\\"addToPrompt\\\": \\\"[SDLC Backpressure] Type errors detected. Run tsc --noEmit to see details.\\\"}\"; fi; fi; exit 0'",
          "timeout": 15
        },
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); FILE=$(echo \"$INPUT\" | jq -r \".tool_input.file_path // empty\" 2>/dev/null); SYNC_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-doc-sync.json\"; mkdir -p \"${CLAUDE_PROJECT_ROOT:-.}/.claude\"; if echo \"$FILE\" | grep -qE \"\\.(py|ts|tsx|js|jsx)$\"; then if [ ! -f \"$SYNC_FILE\" ]; then echo \"{\\\"code_changes\\\":[],\\\"requirements_changes\\\":[],\\\"pending_sync\\\":false,\\\"last_doc_update\\\":null}\" > \"$SYNC_FILE\"; fi; CURRENT=$(cat \"$SYNC_FILE\"); echo \"$CURRENT\" | jq \".code_changes += [{\\\"file\\\": \\\"$FILE\\\", \\\"timestamp\\\": \\\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\\"}] | .code_changes = (.code_changes | unique_by(.file) | .[-20:])\" > \"$SYNC_FILE\" 2>/dev/null; COUNT=$(jq \".code_changes | length\" \"$SYNC_FILE\" 2>/dev/null); DOC_UPDATE=$(jq -r \".last_doc_update // empty\" \"$SYNC_FILE\" 2>/dev/null); if [ \"$COUNT\" -ge 5 ] && [ -z \"$DOC_UPDATE\" ]; then jq \".pending_sync = true\" \"$SYNC_FILE\" > \"${SYNC_FILE}.tmp\" && mv \"${SYNC_FILE}.tmp\" \"$SYNC_FILE\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC DOC-SYNC] $COUNT code files modified without documentation update. Consider invoking documentation-engineer agent.\\\"}\"; fi; fi; exit 0'",
          "timeout": 5
        }
      ]
    },
    {
      "matcher": "Bash",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); OUTPUT=$(echo \"$INPUT\" | jq -r \".tool_result.stdout // empty\" 2>/dev/null); if echo \"$OUTPUT\" | grep -qiE \"(error|failed|exception)\"; then echo \"{\\\"addToPrompt\\\": \\\"[SDLC Backpressure] Command output contains errors. Review and fix before proceeding.\\\"}\"; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ],

  "PhaseTransition": [
    {
      "matcher": ".*",
      "hooks": [
        {
          "type": "command",
          "command": "bash -c 'INPUT=$(cat); FROM_PHASE=$(echo \"$INPUT\" | jq -r \".from_phase // empty\" 2>/dev/null); TO_PHASE=$(echo \"$INPUT\" | jq -r \".to_phase // empty\" 2>/dev/null); STATE_FILE=\"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-state.json\"; TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ); if [ -f \"$STATE_FILE\" ] && [ -n \"$FROM_PHASE\" ] && [ -n \"$TO_PHASE\" ]; then CHECKPOINT=\"{\\\"phase\\\": \\\"$FROM_PHASE\\\", \\\"completed_at\\\": \\\"$TIMESTAMP\\\", \\\"transitioned_to\\\": \\\"$TO_PHASE\\\"}\"; jq \".phases.$FROM_PHASE.status = \\\"completed\\\" | .phases.$FROM_PHASE.completed_at = \\\"$TIMESTAMP\\\" | .phases.$TO_PHASE.status = \\\"in_progress\\\" | .phases.$TO_PHASE.started_at = \\\"$TIMESTAMP\\\" | .current_phase = \\\"$TO_PHASE\\\" | .checkpoints += [$CHECKPOINT]\" \"$STATE_FILE\" > \"${STATE_FILE}.tmp\" && mv \"${STATE_FILE}.tmp\" \"$STATE_FILE\"; HANDOFF=\"{\\\"from_phase\\\": \\\"$FROM_PHASE\\\", \\\"to_phase\\\": \\\"$TO_PHASE\\\", \\\"handoff_at\\\": \\\"$TIMESTAMP\\\"}\"; jq \".handoffs += [$HANDOFF]\" \"$STATE_FILE\" > \"${STATE_FILE}.tmp\" && mv \"${STATE_FILE}.tmp\" \"$STATE_FILE\"; echo \"$(date) [SDLC] Phase transition: $FROM_PHASE -> $TO_PHASE\" >> \"${CLAUDE_PROJECT_ROOT:-.}/.claude/sdlc-activity.log\"; echo \"{\\\"addToPrompt\\\": \\\"[SDLC PHASE TRANSITION] $FROM_PHASE completed. Starting $TO_PHASE phase. Checkpoint created.\\\"}\"; fi; exit 0'",
          "timeout": 5
        }
      ]
    }
  ]
}
