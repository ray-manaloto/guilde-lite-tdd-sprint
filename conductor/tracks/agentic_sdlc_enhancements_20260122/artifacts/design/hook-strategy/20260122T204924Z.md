# Design Notes (hook-strategy)

## Goals
- Enforce Conductor workflow in Codex sessions.
- Keep inner loop fast; push heavy checks to PR/nightly gates.
- Ensure research, plan approval, and verification checkpoints are never skipped.

## Strategy (Codex-first, Claude-compatible)

### Layer 1: Codex Session Guards (primary)
- Implement a Codex guard wrapper that runs before any Codex CLI execution.
- Guard checks:
  - Active track available via `CONDUCTOR_TRACK_ID` or `--track-id`.
  - Plan status is approved before implementation steps.
  - Research tasks have `conductor/tracks/<id>/research.md`.
  - Phase boundary requires manual verification confirmation.
- Recommended entrypoints (design):
  - `scripts/codex/guard.sh` (preflight, exits non-zero on violations).
  - `scripts/codex/run.sh` (invokes guard, then runs `codex exec`).
  - `scripts/codex/snapshot.sh` (writes session recovery artifact).

### Layer 2: Repo-Level Git Hooks (secondary)
- `pre-commit`: fast lint/format checks only.
- `pre-push`: PR smoke gate or fail if Conductor plan markers not updated.
- Hooks should call `scripts/codex/guard.sh` for workflow enforcement.

### Layer 3: CI Gates (authoritative)
- PR smoke gate runs:
  - backend integration subset (no mocks)
  - frontend E2E smoke
  - lint + type checks
- Nightly gate runs:
  - full integration suite
  - full E2E + visual/a11y

## Command Set (Design)
- `project cmd deep-research --track-id <id> --query <text>`
- `project cmd conductor-plan --track-id <id> ...`
- `project cmd codex-guard --track-id <id> --phase <phase>`
- `project cmd snapshot-state --track-id <id>`
- `project cmd qa-smoke` and `project cmd qa-nightly`
- `project cmd sync-docs --track-id <id>`

## Enforcement Rules
- Research tasks: block without a deep research artifact.
- Implementation tasks: block without plan approval.
- Phase boundary: block until Verify step is acknowledged.
- Documentation sync: warn if plan/spec updated without docs.

## Outputs
- `conductor/tracks/<id>/artifacts/state/<timestamp>.md`
- `conductor/tracks/<id>/artifacts/state/<timestamp>.state.json`
- `conductor/tracks/<id>/artifacts/logs/<timestamp>.md`

## Notes
- Claude Code hooks remain supported in `.claude/settings.json` for Claude sessions.
- Codex enforcement should not rely on Claude-specific hooks; use wrapper + git hooks.

## Sources
- `docs/conductor-alignment.md`
- `conductor/tracks/agentic_sdlc_enhancements_20260122/research.md`
