# Design Decisions
- **Parallel doc-sync subagent**: Run a documentation-engineer subagent alongside implementation tasks in every phase to update docs/spec/plan in near‑real time and reduce drift.
- **Hook-driven doc sync**: Use `PostToolUse` to trigger doc sync after code edits or tests; use `Stop/SubagentStop` to enforce completion checks before exit.
- **Crash recovery snapshots**: Use `SessionEnd` to capture git status + diff summary, plan task markers, and last command outputs; store in Conductor artifacts for fast recovery.
- **Session restore**: Use `SessionStart` to reload the snapshot, reopen the plan‑of‑record, and display recovery instructions to the operator/agent.
- **Context compaction safety**: Use `PreCompact` to write a short recovery note (current goal, next steps, blockers) before compaction.
- **Operator commands**: Add `/sync-docs`, `/sync-plan`, `/recovery-status` to standardize manual overrides and emergency recovery checks.
- **Alignment automation**: Include deterministic checks that compare spec/plan/docs against code changes (e.g., doc coverage for changed modules, plan task closure status).

# Deliverables
- **Workflow specs**
  - Doc sync workflow diagram with hook triggers and subagent responsibilities.
  - Crash recovery flow (SessionEnd → artifact snapshot → SessionStart restore).
- **Hook configurations**
  - `PostToolUse` doc sync trigger.
  - `Stop/SubagentStop` completion check.
  - `SessionEnd` snapshotter.
  - `SessionStart` restorer.
  - `PreCompact` recovery note.
- **Commands**
  - `/sync-docs` (runs doc sync checks + updates).
  - `/sync-plan` (reconciles plan tasks with code + docs).
  - `/recovery-status` (prints last snapshot + drift status).
- **Automation checks**
  - Doc drift check (docs/spec/plan touched when code changes).
  - Plan-of-record check (task markers updated on merge).
  - Recovery artifact integrity check (snapshot available).
- **Documentation updates**
  - CLAUDE.md (workflow conventions, required hooks, command usage).
  - Conductor templates for recovery notes + doc sync reports.

# Gates
- **PR Gate (Smoke)**
  - `PostToolUse` doc sync run recorded.
  - Doc/spec/plan drift check passes.
  - Plan task markers updated for code changes.
- **Merge Gate**
  - Documentation-engineer subagent report attached (diff summary + doc updates).
  - `/sync-plan` output attached to PR.
- **Nightly Gate**
  - Full doc/spec/plan alignment audit.
  - Recovery artifact validation (snapshot exists and is readable).
- **Session Exit Gate**
  - `Stop/SubagentStop` ensures doc sync complete and recovery snapshot written.

# Risks/Dependencies
- **Hook reliability**: Hook failures can silently skip doc updates—need monitoring/alerts.
- **Over‑automation**: Aggressive doc sync could slow inner dev loops; must be optimized.
- **Drift between artifacts**: Inconsistent updates across code/spec/plan if subagent fails.
- **Context rot**: Recovery notes can become stale if not pruned or updated.
- **Tooling dependency**: Requires stable Conductor artifacts, hook system, and headless runner.

# Open Questions
- How do we detect and resolve conflicting updates when multiple agents edit docs concurrently?
- What is the minimal snapshot payload that still enables reliable recovery?
- Should `/sync-docs` auto‑commit updates or create a separate doc‑only patch?
- How do we score “doc completeness” without encouraging noise or redundant prose?
- How should roles evolve as doc sync becomes more automated—does doc engineer remain separate or fold into dev workflows?