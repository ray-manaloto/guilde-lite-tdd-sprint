# Paired Subagent Review (business-analyst)

Provider: anthropic
Model: claude-opus-4-5-20251101

---

# Actionable Takeaways for Spec/Plan

## OpenAI Agents SDK Orchestration

1. **Adopt hybrid LLM-led + code-led orchestration**
   - Use code-led orchestration for predictable, auditable workflows (CI/CD, billing, compliance tasks)
   - Reserve LLM-led mode for open-ended planning tasks where dynamic delegation adds value
   - **Decision to encode:** Define which agent flows are code-led vs LLM-led in architecture docs; default to code-led for production-critical paths

2. **Implement modular handoffs with explicit contracts**
   - Leverage SDK's `handoff(...)` primitive to delegate subtasks to specialist agents
   - Define typed input/output schemas for each handoff boundary
   - **Risk:** Implicit handoff chains can create debugging nightmares—enforce explicit handoff registration in agent configs

3. **Mandate structured outputs + input guardrails**
   - Use JSON schema constraints on all agent responses to ensure parseable outputs
   - Add input guardrails (prompt filters, approval gates) for user-facing agents
   - **Decision to encode:** All agent definitions must include `output_schema` and at least one input guardrail; fail CI if missing

4. **Instrument agents from day one**
   - Track cost, latency, and accuracy metrics per agent/model combination
   - **Risk:** Without instrumentation, cost overruns and latency regressions go undetected until production incidents

---

## LiteLLM Anthropic Routing

5. **Use `anthropic/` prefix for Claude model routing**
   - Configure LiteLLM proxy with `model="anthropic/claude-3-5-sonnet-20240620"` pattern
   - Leverage automatic parameter mapping (e.g., `max_tokens` defaults, `reasoning_effort` → `output_config`)
   - **Decision to encode:** Centralize model name constants in a config module; never hardcode model strings in business logic

6. **Enable structured outputs for Claude 4.x models**
   - LiteLLM auto-injects `anthropic-beta: structured-outputs-2025-11-13` header for Sonnet 4.5/Opus 4.1
   - Ensure JSON schema prompts are compatible with Anthropic's `output_schema` format
   - **Risk:** Older Claude models don't support structured outputs—add runtime validation to fallback gracefully

7. **Configure passthrough for full feature parity**
   - Use `LITELLM_PROXY_BASE_URL/anthropic/v1/messages` for streaming, batches, and cost tracking
   - **Decision to encode:** Document required environment variables (`LITELLM_PROXY_BASE_URL`, `ANTHROPIC_AUTH_TOKEN`) in `.env.example` and CI secrets

---

## Pytest Integration Test Gating

8. **Register and gate integration tests with markers**
   - Define in `pyproject.toml`:
     ```toml
     [tool.pytest.ini_options]
     markers = [
         "integration: marks tests requiring network/db/external services",
     ]
     ```
   - Add `conftest.py` hook to auto-skip `@pytest.mark.integration` tests unless explicitly requested
   - **Decision to encode:**
     - CI "fast" pipeline: `pytest -m "not integration"`
     - CI "full" pipeline (merge gating): `pytest -m integration
