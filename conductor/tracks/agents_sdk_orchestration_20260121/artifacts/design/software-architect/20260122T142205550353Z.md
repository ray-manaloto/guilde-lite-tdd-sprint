# Design Notes (software-architect)

## Goals and Constraints
- Conductor artifacts are canonical; DB mirrors them.
- Orchestration uses OpenAI Agents SDK for OpenAI models.
- Anthropic access is via LiteLLM only.
- No new PydanticAI usage in orchestration/planning paths.
- CLI-first planning flow owns --output-format/--output-schema.

## Runner Interface
- Introduce an Agents SDK runner that is provider-agnostic at the call site.
- Define a minimal interface that supports parallel role execution and a judge.

```python
class AgentRunResult:
    role: str
    output_md: str
    output_json: dict | None
    usage: dict | None
    model: str
    tool_names: list[str]

class AgentsRunner:
    async def run_role(self, *, role: str, prompt: str, schema: dict | None) -> AgentRunResult: ...
    async def run_paired(self, *, role: str, prompt: str, schema: dict | None) -> tuple[AgentRunResult, AgentRunResult]: ...
    async def run_judge(self, *, prompt: str, schema: dict | None) -> AgentRunResult: ...
```

- Use `ModelSettings(include_usage=True)` to capture usage.
- Parallelize with asyncio for roles defined in spec.md.

## CLI Interview Ownership
- Add a `conductor` CLI group (new) under `backend/cli/commands.py`.
- Add `conductor plan` (or `conductor interview`) as the CLI entrypoint for
  spec/plan generation.
- `conductor plan` owns `--output-format` and `--output-schema`.
- The DB `spec-run` command remains DB-centric and does not own these flags.

## Structured Outputs
- Default `--output-format` is `markdown`.
- When `--output-format json`:
  - Require a JSON schema (built-in default if `--output-schema` not provided).
  - Output schema should include both spec and plan material to avoid split writes.

Suggested default schema shape:
```json
{
  "type": "object",
  "required": ["spec_markdown", "plan_markdown", "open_questions"],
  "properties": {
    "spec_markdown": {"type": "string"},
    "plan_markdown": {"type": "string"},
    "open_questions": {"type": "array", "items": {"type": "string"}},
    "confidence": {"type": "string", "enum": ["low", "medium", "high"]}
  }
}
```

- Persist the schema alongside artifacts for reproducibility.

## Artifact Write/Update Contract
- For every agent run:
  - Write Markdown artifact: `conductor/tracks/<id>/artifacts/<phase>/<role>/<timestamp>.md`.
  - Write state JSON next to it with required fields.
- Any DB write must mirror the Conductor artifact path + content hash.
- Plan updates must be in `conductor/tracks/<id>/plan.md` only.

## Confidence/Vagueness Gate (Interface Stub)
- Runner returns `confidence` in JSON output (or derives from a gate function).
- If confidence is `low`:
  - CLI requires manual confirmation before proceeding to the next phase.

## Testability Notes
- Add schema validation tests for JSON output path.
- Maintain `pytest -m integration` gate for artifact writes (no mocks).
