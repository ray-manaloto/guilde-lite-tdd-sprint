# Design Notes (network-engineer)

## LiteLLM Routing for Anthropic
- All Anthropic traffic goes through LiteLLM.
- Use `LitellmModel(model="anthropic/<model>")` in Agents SDK.
- Configure proxy base URL when present:
  - `LITELLM_PROXY_BASE_URL` (preferred)
  - `LITELLM_API_KEY` if proxy is secured

## Network and Security Controls
- Do not allow direct calls to Anthropic endpoints in application code.
- Enforce via:
  - Code review rule: no direct anthropic SDK usage.
  - Env policy: set `ANTHROPIC_API_KEY` only in LiteLLM proxy context.
  - Optional egress restriction in deployment (block anthropic domains).

## Observability
- Log LiteLLM request metadata (model, latency, tokens) at proxy.
- Mirror cost/usage into DB alongside artifact writes.

## Reliability
- Standardize timeouts and retries at the model adapter layer.
- Prefer circuit breaker behavior for repeated proxy failures.

## Compatibility Notes
- Structured output support depends on Anthropic model version.
- If model does not support structured outputs, fall back to markdown output
  and mark `confidence=low` for manual confirmation.
